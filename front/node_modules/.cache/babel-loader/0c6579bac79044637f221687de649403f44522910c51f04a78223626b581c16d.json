{"ast":null,"code":"// src/hooks/useWebSocket.js\nimport{useState,useEffect,useCallback,useRef}from'react';const WS_URL='ws://218.156.126.186:8000/ws';function useWebSocket(user){const[socket,setSocket]=useState(null);const[messages,setMessages]=useState([]);const[userCount,setUserCount]=useState(0);const[chatBanTimeLeft,setChatBanTimeLeft]=useState(0);const[isConnecting,setIsConnecting]=useState(false);const socketRef=useRef(null);const setupWebSocket=useCallback(()=>{if(!user||isConnecting)return;setIsConnecting(true);if(socketRef.current){socketRef.current.close();}const newSocket=new WebSocket(`${WS_URL}/${user.userId}`);socketRef.current=newSocket;newSocket.onopen=()=>{console.log('WebSocket Connected');setSocket(newSocket);setIsConnecting(false);};newSocket.onmessage=event=>{const data=JSON.parse(event.data);console.log('Received message:',data);if(data.type==='user_count'){setUserCount(data.count);}else if(data.type==='chat_banned'){setChatBanTimeLeft(data.time_left);}else if(data.type==='session_expired'){// 세션 만료 처리\n}else{setMessages(prev=>[...prev,data]);}};newSocket.onclose=()=>{console.log('WebSocket Disconnected');setSocket(null);setIsConnecting(false);setTimeout(setupWebSocket,3000);};newSocket.onerror=error=>{console.error('WebSocket Error:',error);setIsConnecting(false);};return()=>{if(socketRef.current){socketRef.current.close();}};},[user]);useEffect(()=>{if(user){setupWebSocket();}return()=>{if(socketRef.current){socketRef.current.close();}};},[user,setupWebSocket]);const sendMessage=useCallback(messageText=>{if(socket&&socket.readyState===WebSocket.OPEN&&user){const messageObj={message:messageText,sender:user.userId,username:user.username,timestamp:Date.now()};socket.send(JSON.stringify(messageObj));}else{console.error('WebSocket is not connected or user is not logged in');}},[socket,user]);return{socket,messages,userCount,chatBanTimeLeft,sendMessage,isConnecting};}export default useWebSocket;","map":{"version":3,"names":["useState","useEffect","useCallback","useRef","WS_URL","useWebSocket","user","socket","setSocket","messages","setMessages","userCount","setUserCount","chatBanTimeLeft","setChatBanTimeLeft","isConnecting","setIsConnecting","socketRef","setupWebSocket","current","close","newSocket","WebSocket","userId","onopen","console","log","onmessage","event","data","JSON","parse","type","count","time_left","prev","onclose","setTimeout","onerror","error","sendMessage","messageText","readyState","OPEN","messageObj","message","sender","username","timestamp","Date","now","send","stringify"],"sources":["/home/work/chat/front/src/hooks/useWebSocket.js"],"sourcesContent":["// src/hooks/useWebSocket.js\n\nimport { useState, useEffect, useCallback, useRef } from 'react';\n\nconst WS_URL = 'ws://218.156.126.186:8000/ws';\n\nfunction useWebSocket(user) {\n  const [socket, setSocket] = useState(null);\n  const [messages, setMessages] = useState([]);\n  const [userCount, setUserCount] = useState(0);\n  const [chatBanTimeLeft, setChatBanTimeLeft] = useState(0);\n  const [isConnecting, setIsConnecting] = useState(false);\n  const socketRef = useRef(null);\n\n  const setupWebSocket = useCallback(() => {\n    if (!user || isConnecting) return;\n\n    setIsConnecting(true);\n    if (socketRef.current) {\n      socketRef.current.close();\n    }\n\n    const newSocket = new WebSocket(`${WS_URL}/${user.userId}`);\n    socketRef.current = newSocket;\n\n    newSocket.onopen = () => {\n      console.log('WebSocket Connected');\n      setSocket(newSocket);\n      setIsConnecting(false);\n    };\n\n    newSocket.onmessage = (event) => {\n      const data = JSON.parse(event.data);\n      console.log('Received message:', data);\n      if (data.type === 'user_count') {\n        setUserCount(data.count);\n      } else if (data.type === 'chat_banned') {\n        setChatBanTimeLeft(data.time_left);\n      } else if (data.type === 'session_expired') {\n        // 세션 만료 처리\n      } else {\n        setMessages(prev => [...prev, data]);\n      }\n    };\n\n    newSocket.onclose = () => {\n      console.log('WebSocket Disconnected');\n      setSocket(null);\n      setIsConnecting(false);\n      setTimeout(setupWebSocket, 3000);\n    };\n\n    newSocket.onerror = (error) => {\n      console.error('WebSocket Error:', error);\n      setIsConnecting(false);\n    };\n\n    return () => {\n      if (socketRef.current) {\n        socketRef.current.close();\n      }\n    };\n  }, [user]);\n\n  useEffect(() => {\n    if (user) {\n      setupWebSocket();\n    }\n    return () => {\n      if (socketRef.current) {\n        socketRef.current.close();\n      }\n    };\n  }, [user, setupWebSocket]);\n\n  const sendMessage = useCallback((messageText) => {\n    if (socket && socket.readyState === WebSocket.OPEN && user) {\n      const messageObj = {\n        message: messageText,\n        sender: user.userId,\n        username: user.username,\n        timestamp: Date.now()\n      };\n      socket.send(JSON.stringify(messageObj));\n    } else {\n      console.error('WebSocket is not connected or user is not logged in');\n    }\n  }, [socket, user]);\n\n  return { socket, messages, userCount, chatBanTimeLeft, sendMessage, isConnecting };\n}\n\nexport default useWebSocket;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}